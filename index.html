<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>世界時間轉換</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
  <link rel="icon" href="image/clock-icon.ico" sizes="64x64" type="image/x-icon">
  <style>
    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(to right, #f2f7ff, #e6ecff);
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: start;
      min-height: 100vh;
      color: #5C2E1A;
    }
    h1 { margin-top: 40px; color: #FF6B3B; font-size: 40px; font-weight: 700; }

    .buttons { margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap; }
    button {
      background-color: #0056b3;
      color: white;
      font-size: 18px;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, opacity 0.2s ease;
    }
    button:hover { background-color: #003d7a; }
    button[disabled] { opacity: 0.5; cursor: default; }

    .container {
      display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
      gap: 30px; margin-top: 40px;
    }
    .time-box {
      background: white; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      width: 320px; padding: 25px; text-align: center;
    }
    .label {
      font-size: 22px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
      align-items: baseline;
    }
    .label .tz-info {
      font-size: 16px;
      font-weight: 600;
      color: #8B5A3C;
    }

    .time { font-size: 48px; font-weight: 700; color: #007BFF; }
    .date { font-size: 22px; color: #28a745; margin-top: 10px; }
    .weekday {
      font-size: 18px;
      color: #000000;
      font-weight: 700;
      margin-top: 10px;
    }

    /* DST 區塊置中與更緊湊的等高 */
    #dst-section {
      width: 100%;
      max-width: 1080px;
      margin: 0 auto;
    }
    .dst-title { margin-top: 60px; font-size: 26px; font-weight: 700; color: #FF6B3B; text-align: center; }

    .dst-controls {
      margin-top: 12px;
      display: flex;
      gap: 84px;
      justify-content: center;
    }
    .dst-container {
      display: grid;
      grid-template-columns: repeat(3, minmax(280px, 1fr));
      gap: 20px;
      align-items: stretch;
      justify-items: center;
      margin-top: 20px;
    }
    .dst-box {
      background: #ffffff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      width: 100%; max-width: 300px; padding: 18px;
      font-size: 16px; text-align: left; line-height: 1.55;
      color: #000000;
      display: flex; flex-direction: column; justify-content: flex-start;
      min-height: 120px;
    }
    /* 將 上一個 / 現在 / 下一個 標題改為淺藍色（不會太淺）*/
    .dst-box strong { color: #2E86C1; }

    .hidden { display: none; }

    @media (max-width: 768px) {
      .container { flex-direction: column; gap: 20px; }
      .time-box { width: 90%; }
      .dst-container { grid-template-columns: 1fr; }
      .dst-box { max-width: 100%; }
      .dst-controls { gap: 16px; }
    }
    @media (min-width: 769px) and (max-width: 1024px) {
      .dst-container { grid-template-columns: repeat(2, minmax(280px, 1fr)); }
      .dst-controls { gap: 28px; }
    }
  </style>
  <script>
    let currentMode = "EST_PST";
    let currentDSTZone = "America/New_York";

    function getTimeZoneAbbreviation(timeZone, date = new Date()) {
      try {
        const formatter = new Intl.DateTimeFormat("en-US", { timeZone, timeZoneName: "short" });
        const parts = formatter.formatToParts(date);
        const tzPart = parts.find(part => part.type === "timeZoneName");
        return tzPart ? tzPart.value : "";
      } catch (e) {
        return "";
      }
    }

    // 回傳偏移字串 +08:00（不含 "UTC"）
    function getUTCOffset(timeZone, date = new Date()) {
      try {
        const utcMs = Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate(), date.getUTCHours(), date.getUTCMinutes(), date.getUTCSeconds());
        const localParts = new Intl.DateTimeFormat('en-US', {
          timeZone,
          hour12: false,
          year: 'numeric',
          month: 'numeric',
          day: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric'
        }).formatToParts(date).reduce((acc, part) => {
          if (part.type !== 'literal') acc[part.type] = part.value;
          return acc;
        }, {});
        const tzYear = Number(localParts.year);
        const tzMonth = Number(localParts.month) - 1;
        const tzDay = Number(localParts.day);
        const tzHour = Number(localParts.hour);
        const tzMinute = Number(localParts.minute);
        const tzSecond = Number(localParts.second);
        const tzMs = Date.UTC(tzYear, tzMonth, tzDay, tzHour, tzMinute, tzSecond);
        const diffMinutes = Math.round((tzMs - utcMs) / 60000);
        const sign = diffMinutes >= 0 ? "+" : "-";
        const absMin = Math.abs(diffMinutes);
        const h = Math.floor(absMin / 60).toString().padStart(2, "0");
        const m = (absMin % 60).toString().padStart(2, "0");
        return `${sign}${h}:${m}`;
      } catch (e) {
        return "";
      }
    }

    function updateTime() {
      const timeZones = {
        "EST_PST": ["America/New_York", "America/Los_Angeles"],
        "TST_JST": ["Asia/Taipei", "Asia/Tokyo"]
      };
      const labels = {
        "EST_PST": ["美東時間", "太平洋時間"],
        "TST_JST": ["台灣時間", "日本時間"]
      };

      const zones = timeZones[currentMode];
      const times = zones.map(zone => new Date(new Date().toLocaleString("en-US", { timeZone: zone })));

      document.getElementById("time1").innerText = times[0].toLocaleTimeString("en-US", { hour12: false });
      document.getElementById("date1").innerText = times[0].toLocaleDateString("zh-TW", { year: "numeric", month: "long", day: "numeric" });
      document.getElementById("weekday1").innerText = times[0].toLocaleString("zh-TW", { weekday: "long" });

      document.getElementById("time2").innerText = times[1].toLocaleTimeString("en-US", { hour12: false });
      document.getElementById("date2").innerText = times[1].toLocaleDateString("zh-TW", { year: "numeric", month: "long", day: "numeric" });
      document.getElementById("weekday2").innerText = times[1].toLocaleString("zh-TW", { weekday: "long" });

      document.getElementById("toggleButton").innerText =
        currentMode === "EST_PST" ? "切換至 台灣 & 日本" : "切換至 美東 & 太平洋";

      const dstSection = document.getElementById("dst-section");
      const dstControls = document.getElementById("dst-controls");
      dstSection.classList.toggle("hidden", currentMode === "TST_JST");
      dstControls.classList.toggle("hidden", currentMode === "TST_JST");

      if (currentMode === "TST_JST") {
        document.getElementById("time1-label").innerHTML = `${labels[currentMode][0]} <span class="tz-info">CST +08:00</span>`;
        document.getElementById("time2-label").innerHTML = `${labels[currentMode][1]} <span class="tz-info">JST +09:00</span>`;
      } else {
        const abbr1 = getTimeZoneAbbreviation(zones[0], times[0]) || "";
        const abbr2 = getTimeZoneAbbreviation(zones[1], times[1]) || "";
        const offset1 = getUTCOffset(zones[0], times[0]) || "";
        const offset2 = getUTCOffset(zones[1], times[1]) || "";
        document.getElementById("time1-label").innerHTML = `${labels[currentMode][0]} <span class="tz-info">${abbr1} ${offset1}</span>`;
        document.getElementById("time2-label").innerHTML = `${labels[currentMode][1]} <span class="tz-info">${abbr2} ${offset2}</span>`;
      }

      if (currentMode === "EST_PST") {
        updateDSTInfo(currentDSTZone);
      }
    }

    function toggleTime() {
      currentMode = currentMode === "EST_PST" ? "TST_JST" : "EST_PST";
      updateTime();
    }

    function selectDSTZone(zone) {
      currentDSTZone = zone;
      document.getElementById("btn-EST").disabled = (zone === "America/New_York");
      document.getElementById("btn-PST").disabled = (zone === "America/Los_Angeles");
      updateDSTInfo(zone);
    }

    function getTimeZoneAbbreviation(timeZone, date = new Date()) {
      try {
        const formatter = new Intl.DateTimeFormat("en-US", { timeZone, timeZoneName: "short" });
        const parts = formatter.formatToParts(date);
        const tzPart = parts.find(part => part.type === "timeZoneName");
        return tzPart ? tzPart.value : "";
      } catch (e) {
        return "";
      }
    }

    function nthWeekdayOfMonth(year, monthIndex, weekdayIndex, n) {
      const firstDay = new Date(year, monthIndex, 1);
      const firstWeekday = firstDay.getDay();
      const offset = (weekdayIndex - firstWeekday + 7) % 7;
      const day = 1 + offset + (n - 1) * 7;
      return new Date(year, monthIndex, day);
    }
    function firstWeekdayOfMonth(year, monthIndex, weekdayIndex) {
      return nthWeekdayOfMonth(year, monthIndex, weekdayIndex, 1);
    }
    function formatTWDate(d) {
      return d.toLocaleDateString("zh-TW", { year: "numeric", month: "long", day: "numeric" });
    }

    function updateDSTInfo(zone) {
      const now = new Date();
      const year = now.getFullYear();

      const dstStartLocal = nthWeekdayOfMonth(year, 2, 0, 2); // Mar, 2nd Sunday
      dstStartLocal.setHours(2, 0, 0, 0);
      const dstEndLocal = firstWeekdayOfMonth(year, 10, 0); // Nov, 1st Sunday
      dstEndLocal.setHours(2, 0, 0, 0);

      const tzAbbrNow = getTimeZoneAbbreviation(zone, now);
      const isDSTNow = tzAbbrNow.includes("DT");

      const zoneBase = zone === "America/New_York" ? "E" : "P";
      const stdAbbr = zoneBase === "E" ? "EST" : "PST";
      const dstAbbr = zoneBase === "E" ? "EDT" : "PDT";
      const utcStd = zoneBase === "E" ? "UTC -5:00" : "UTC -8:00";
      const utcDst = zoneBase === "E" ? "UTC -4:00" : "UTC -7:00";

      let prevTitle = "上一個:", nextTitle = "下一個:";
      let prevBody = "", nextBody = "";

      if (isDSTNow) {
        prevBody = `${formatTWDate(dstStartLocal)} (週日)<br> 01:59 → 03:00<br>${stdAbbr} → ${dstAbbr}<br>${utcStd} → ${utcDst}`;
        nextBody = `${formatTWDate(dstEndLocal)} (週日)<br> 01:59 → 01:00<br>${dstAbbr} → ${stdAbbr}<br>${utcDst} → ${utcStd}`;
      } else {
        const hasPassedStart = now >= dstStartLocal;
        const hasPassedEnd = now >= dstEndLocal;

        if (!hasPassedStart) {
          const lastYearEnd = firstWeekdayOfMonth(year - 1, 10, 0);
          lastYearEnd.setHours(2, 0, 0, 0);
          prevBody = `${formatTWDate(lastYearEnd)} (週日)<br> 01:59 → 01:00<br>${dstAbbr} → ${stdAbbr}<br>${utcDst} → ${utcStd}`;
          nextBody = `${formatTWDate(dstStartLocal)} (週日)<br> 01:59 → 03:00<br>${stdAbbr} → ${dstAbbr}<br>${utcStd} → ${utcDst}`;
        } else if (!hasPassedEnd) {
          prevBody = `${formatTWDate(dstStartLocal)} (週日)<br> 01:59 → 03:00<br>${stdAbbr} → ${dstAbbr}<br>${utcStd} → ${utcDst}`;
          nextBody = `${formatTWDate(dstEndLocal)} (週日)<br> 01:59 → 01:00<br>${dstAbbr} → ${stdAbbr}<br>${utcDst} → ${utcStd}`;
        } else {
          prevBody = `${formatTWDate(dstEndLocal)} (週日)<br> 01:59 → 01:00<br>${dstAbbr} → ${stdAbbr}<br>${utcDst} → ${utcStd}`;
          const nextYearStart = nthWeekdayOfMonth(year + 1, 2, 0, 2);
          nextYearStart.setHours(2, 0, 0, 0);
          nextBody = `${formatTWDate(nextYearStart)} (週日)<br> 01:59 → 03:00<br>${stdAbbr} → ${dstAbbr}<br>${utcStd} → ${utcDst}`;
        }
      }

      const zoneNowAbbr = getTimeZoneAbbreviation(zone, new Date());
      const utcOffsetNow = isDSTNow ? utcDst : utcStd;
      const dstStatus = isDSTNow ? "DST On" : "DST Off";

      document.getElementById("dst-prev").innerHTML =
        `<strong>${prevTitle}</strong><br>${prevBody}`;
      document.getElementById("dst-current").innerHTML =
        `<strong>現在:</strong><br>時區: ${zoneNowAbbr}<br>${utcOffsetNow}<br>${dstStatus}`;
      document.getElementById("dst-next").innerHTML =
        `<strong>${nextTitle}</strong><br>${nextBody}`;
    }

    // 每秒更新時間顯示（並在每次更新時重新取得時區縮寫與偏移，確保未來夏令時間變更會自動反映）
    setInterval(updateTime, 1000);

    // 初始載入
    updateTime();
    selectDSTZone("America/New_York");
  </script>
</head>
<body>
  <h1>世界時間轉換</h1>

  <div class="buttons">
    <button id="toggleButton" onclick="toggleTime()">切換至 台灣 & 日本</button>
  </div>

  <div class="container">
    <div class="time-box">
      <div class="label" id="time1-label">EST 時間 <span class="tz-info"></span></div>
      <div class="time" id="time1"></div>
      <div class="date" id="date1"></div>
      <div class="weekday" id="weekday1"></div>
    </div>

    <div class="time-box">
      <div class="label" id="time2-label">PST 時間 <span class="tz-info"></span></div>
      <div class="time" id="time2"></div>
      <div class="date" id="date2"></div>
      <div class="weekday" id="weekday2"></div>
    </div>
  </div>

  <div id="dst-section">
    <div class="dst-title">夏令時間變化</div>

    <div class="dst-controls" id="dst-controls">
      <button id="btn-EST" onclick="selectDSTZone('America/New_York')" disabled>美東夏令時間</button>
      <button id="btn-PST" onclick="selectDSTZone('America/Los_Angeles')">太平洋夏令時間</button>
    </div>

    <div class="dst-container">
      <div class="dst-box" id="dst-prev"></div>
      <div class="dst-box" id="dst-current"></div>
      <div class="dst-box" id="dst-next"></div>
    </div>
  </div>
</body>
</html>
